generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Keyword {
  id         String   @id
  term       String   @unique
  definition String
  createdAt  DateTime @default(now())
  updatedAt  DateTime

  @@index([term])
}

model LearningProgress {
  id            String   @id
  userId        String   @unique
  currentDeck   Int      @default(1)
  unlockedDecks Int      @default(1)
  updatedAt     DateTime
  User          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Module {
  id              String       @id @default(uuid())
  key             LessonModule @unique
  title           String
  shortName       String
  description     String
  displayOrder    Int
  backgroundColor String      @default("#E4E4FF")
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([displayOrder])
}

model Lesson {
  id                 String               @id
  module             LessonModule
  dayNumber          Int
  title              String
  subtitle           String?
  shortDescription   String
  objectives         String[]
  estimatedMinutes   Int                  @default(2)
  teachesCategories  String[]
  dragonImageUrl     String?
  backgroundColor    String               @default("#E4E4FF")
  ellipse77Color     String               @default("#9BD4DF")
  ellipse78Color     String               @default("#A6E0CB")
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  LessonSegment      LessonSegment[]
  Quiz               Quiz?
  UserLessonProgress UserLessonProgress[]

  @@unique([module, dayNumber])
  @@index([module])
}

model LessonSegment {
  id                String              @id
  lessonId          String
  order             Int
  sectionTitle      String?
  contentType       ContentType
  bodyText          String
  imageUrl          String?
  iconType          String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  aiCheckMode       String?
  idealAnswer       String?
  Lesson            Lesson              @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  TextInputResponse TextInputResponse[]

  @@unique([lessonId, order])
  @@index([lessonId])
}

model ModuleHistory {
  id       String   @id
  userId   String
  category String
  level    Int
  viewedAt DateTime @default(now())
  User     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, category])
  @@index([userId])
  @@index([viewedAt])
}

model PasswordResetToken {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([token])
  @@index([userId])
}

model Phq2Survey {
  id          String   @id
  userId      String
  submittedAt DateTime @default(now())
  q1Interest  Int
  q2Depressed Int
  totalScore  Int
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([submittedAt])
  @@index([userId])
}

model Quiz {
  id            String         @id
  lessonId      String         @unique
  question      String
  correctAnswer String
  explanation   String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime
  Lesson        Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  QuizOption    QuizOption[]
  QuizResponse  QuizResponse[]

  @@index([lessonId])
}

model QuizOption {
  id          String @id
  quizId      String
  optionLabel String
  optionText  String
  order       Int
  Quiz        Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@unique([quizId, optionLabel])
  @@index([quizId])
}

model QuizResponse {
  id             String   @id
  userId         String
  quizId         String
  selectedAnswer String
  isCorrect      Boolean
  attemptNumber  Int      @default(1)
  respondedAt    DateTime @default(now())
  Quiz           Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  User           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([userId, quizId])
}

model RefreshToken {
  id        String   @id
  userId    String   @unique
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([tokenHash])
}

model RiskAuditLog {
  id             String   @id
  userId         String
  sessionId      String?
  timestamp      DateTime @default(now())
  triggerSource  String
  riskLevel      String
  triggerExcerpt String?
  actionTaken    String
  User           User     @relation(fields: [userId], references: [id])

  @@index([riskLevel])
  @@index([timestamp])
  @@index([userId])
}

model Session {
  id                     String          @id
  userId                 String
  mode                   SessionMode
  storagePath            String
  durationSeconds        Int
  transcript             String
  aiFeedbackJSON         Json
  pcitCoding             Json
  tagCounts              Json
  masteryAchieved        Boolean         @default(false)
  riskScore              Int             @default(0)
  flaggedForReview       Boolean         @default(false)
  coachAlertSent         Boolean         @default(false)
  coachAlertSentAt       DateTime?
  createdAt              DateTime        @default(now())
  childMetrics           Json?
  competencyAnalysis     Json?
  overallScore           Int?
  elevenLabsJson         Json?
  roleIdentificationJson Json?
  psychologistFeedback   Json?
  childPortfolioInsights Json?
  aboutChild             Json?
  transcribedAt          DateTime?
  transcriptionService   String?
  analysisError          String?
  analysisFailedAt       DateTime?
  analysisStatus         AnalysisStatus  @default(PENDING)
  lastRetriedAt          DateTime?
  permanentFailure       Boolean         @default(false)
  retryCount             Int             @default(0)
  coachingSummary        String?
  coachingCards          Json?
  milestoneCelebrations  Json?
  userFeedback           Json?
  User                   User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  Utterance              Utterance[]
  ChildProfiling         ChildProfiling?

  @@index([analysisStatus])
  @@index([createdAt])
  @@index([flaggedForReview])
  @@index([mode])
  @@index([userId])
}

model SubscriptionEvent {
  id                String    @id
  userId            String
  revenueCatEventId String    @unique
  eventType         String
  productId         String
  expiresDate       DateTime?
  revenueCatData    Json
  createdAt         DateTime  @default(now())
  User              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([eventType])
  @@index([revenueCatEventId])
  @@index([userId])
}

model SupportRequest {
  id            String               @id
  userId        String
  email         String
  description   String
  attachments   Json?
  status        SupportRequestStatus @default(OPEN)
  priority      SupportPriority      @default(MEDIUM)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime
  resolvedAt    DateTime?
  resolverNotes String?
  User          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([status])
  @@index([userId])
}

model TextInputResponse {
  id            String        @id @default(uuid())
  userId        String
  segmentId     String
  userAnswer    String
  aiEvaluation  Json?
  isCorrect     Boolean       @default(false)
  score         Int?
  attemptNumber Int           @default(1)
  respondedAt   DateTime      @default(now())
  LessonSegment LessonSegment @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  User          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, segmentId])
}

model ThirdPartyRequest {
  id          String   @id
  requestId   String   @unique
  userId      String
  provider    String
  requestType String
  dataHash    String?
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([expiresAt])
  @@index([requestId])
  @@index([userId])
}

model User {
  id                    String               @id
  email                 String               @unique
  passwordHash          String
  name                  String
  therapistId           String?
  childName             String
  createdAt             DateTime             @default(now())
  currentStreak         Int                  @default(0)
  lastSessionDate       DateTime?
  longestStreak         Int                  @default(0)
  childBirthYear        Int
  childConditions       String
  emailHash             String?              @unique
  childBirthday         DateTime?
  issue                 String?
  profileImageUrl       String?
  subscriptionEndDate   DateTime?
  subscriptionPlan      SubscriptionPlan     @default(FREE)
  subscriptionStartDate DateTime?
  subscriptionStatus    SubscriptionStatus   @default(INACTIVE)
  trialEndDate          DateTime?
  trialStartDate        DateTime?
  relationshipToChild   RelationshipToChild  @default(MOTHER)
  childGender           ChildGender?
  pushToken                String?
  pushTokenUpdatedAt       DateTime?
  revenueCatCustomerId     String?              @unique
  developmentalVisible     Boolean              @default(false)
  LearningProgress      LearningProgress?
  ModuleHistory         ModuleHistory[]
  PasswordResetToken    PasswordResetToken[]
  Phq2Survey            Phq2Survey[]
  QuizResponse          QuizResponse[]
  RiskAuditLog          RiskAuditLog[]
  Session               Session[]
  SubscriptionEvent     SubscriptionEvent[]
  SupportRequest        SupportRequest[]
  TextInputResponse     TextInputResponse[]
  ThirdPartyRequest     ThirdPartyRequest[]
  UserLessonProgress    UserLessonProgress[]
  WacbSurvey            WacbSurvey[]
  ChildProfiling        ChildProfiling[]
  Child                 Child[]
  WeeklyReport          WeeklyReport[]

  @@index([emailHash])
  @@index([pushToken])
  @@index([therapistId])
}

model UserLessonProgress {
  id               String         @id
  userId           String
  lessonId         String
  status           ProgressStatus
  currentSegment   Int            @default(1)
  totalSegments    Int            @default(4)
  completedAt      DateTime?
  startedAt        DateTime       @default(now())
  lastViewedAt     DateTime       @default(now())
  timeSpentSeconds Int            @default(0)
  Lesson           Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  User             User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([lessonId])
  @@index([userId, status])
}

model Utterance {
  id              String   @id @default(uuid())
  sessionId       String
  speaker         String
  text            String
  startTime       Float
  endTime         Float
  role            String?
  pcitTag         String?
  order           Int
  createdAt       DateTime @default(now())
  noraTag         String?
  feedback        String?
  additionalTip   String?
  revisedFeedback String?
  Session         Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([sessionId, order])
}

model WacbSurvey {
  id                   String   @id
  userId               String
  submittedAt          DateTime @default(now())
  parentingStressLevel Int
  q1Dawdle             Int
  q2MealBehavior       Int
  q3Disobey            Int
  q4Angry              Int
  q5Scream             Int
  q6Destroy            Int
  q7ProvokeFights      Int
  q8Interrupt          Int
  q9Attention          Int
  totalScore           Int
  User               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  ChildIssuePriority ChildIssuePriority[]

  @@index([submittedAt])
  @@index([userId])
}

model ChildProfiling {
  id        String   @id @default(uuid())
  userId    String
  sessionId String   @unique
  childId   String
  summary   String?
  domains   Json
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  Child     Child    @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
  @@index([childId])
}

model Child {
  id                String                @id @default(uuid())
  userId            String
  name              String
  birthday          DateTime?
  gender            ChildGender?
  conditions        String?
  primaryIssue      ClinicalLevel?
  primaryStrategy   InterventionStrategy?
  secondaryIssue    ClinicalLevel?
  secondaryStrategy InterventionStrategy?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  User               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  ChildMilestone     ChildMilestone[]
  ChildProfiling     ChildProfiling[]
  ChildIssuePriority ChildIssuePriority[]
  WeeklyReport       WeeklyReport[]

  @@index([userId])
}

model ChildIssuePriority {
  id            String               @id @default(uuid())
  childId       String
  clinicalLevel ClinicalLevel
  strategy      InterventionStrategy
  priorityRank  Int
  fromUserIssue Boolean              @default(false)
  fromWacb      Boolean              @default(false)
  userIssues    String?
  wacbQuestions String?
  wacbScore     Int?
  computedAt    DateTime             @default(now())
  wacbSurveyId  String?
  Child         Child                @relation(fields: [childId], references: [id], onDelete: Cascade)
  WacbSurvey    WacbSurvey?          @relation(fields: [wacbSurveyId], references: [id], onDelete: SetNull)

  @@index([childId])
  @@index([childId, computedAt])
  @@index([childId, clinicalLevel, computedAt])
}

model ChildMilestone {
  id               String           @id @default(uuid())
  childId          String
  milestoneId      String
  status           MilestoneStatus
  firstObservedAt  DateTime         @default(now())
  achievedAt       DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  Child            Child            @relation(fields: [childId], references: [id], onDelete: Cascade)
  MilestoneLibrary MilestoneLibrary @relation(fields: [milestoneId], references: [id], onDelete: Cascade)

  @@unique([childId, milestoneId])
  @@index([childId])
  @@index([milestoneId])
  @@index([childId, status])
}

model MilestoneLibrary {
  id                 String           @id @default(uuid())
  key                String           @unique
  category           String
  groupingStage      String           @map("grouping_stage")
  displayTitle       String           @map("display_title")
  detectionMode      String           @map("detection_mode")
  thresholdValue     Int              @map("threshold_value")
  medianAgeMonths    Int              @map("median_age_months")
  mastery90AgeMonths Int              @map("mastery_90_age_months")
  sourceReference    String           @map("source_reference")
  actionTip          String?          @map("action_tip")
  createdAt          DateTime         @default(now()) @map("created_at")
  ChildMilestone     ChildMilestone[]

  @@index([category])
  @@index([medianAgeMonths])
  @@map("milestone_library")
}

enum MilestoneStatus {
  EMERGING
  ACHIEVED
}

enum AnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ChildGender {
  BOY
  GIRL
  OTHER
}

enum ContentType {
  TEXT
  EXAMPLE
  TIP
  SCRIPT
  CALLOUT
  TEXT_INPUT
}

enum LessonModule {
  FOUNDATION
  EMOTIONS
  COOPERATION
  SIBLINGS
  RELOCATION
  DIVORCE
  DEVELOPMENT
  PROCRASTINATION
  PATIENCE
  RESPONSIBILITY
  MEALS
  AGGRESSION
  CONFLICT
  FOCUS
  DEFIANCE
  SAFETY
  SCREENS
  SEPARATION
  SPECIAL
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum RelationshipToChild {
  MOTHER
  FATHER
  GUARDIAN
  OTHER
  GRANDMOTHER
  GRANDFATHER
}

enum SessionMode {
  CDI
  PDI
}

enum SubscriptionPlan {
  TRIAL
  PREMIUM
  FREE
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  NONE
  TRIAL
  INACTIVE
}

enum SupportPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SupportRequestStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum ClinicalLevel {
  STABILIZE       // Level I
  DE_ESCALATE     // Level II
  DIRECT          // Level III
  SUPPORT         // Level IV
  FLOURISH        // Level V
}

model AppConfig {
  key       String   @id
  value     Json
  updatedAt DateTime @updatedAt
}

enum InterventionStrategy {
  AGGRESSIVE_DE_ESCALATION
  DIFFERENTIAL_ATTENTION
  POSITIVE_REINFORCEMENT
  RELATIONSHIP_BUFFERING
  SKILL_COACHING
}

model WeeklyReport {
  id        String   @id @default(uuid())
  userId    String
  childId   String?

  // Week boundaries (Monday 00:00 to Sunday 23:59)
  weekStartDate DateTime
  weekEndDate   DateTime

  // Visibility control — admin can toggle which reports users see
  visibility    Boolean  @default(false)

  // Page 1: Weekly Recap Headline
  headline      String?  // e.g. "Zoey Showed Easier Transition this week"

  // Page 2: Emotional Bank Account Deposits
  totalDeposits       Int @default(0)
  massageTimeMinutes  Int @default(0)
  praiseCount         Int @default(0)
  echoCount           Int @default(0)
  narrateCount        Int @default(0)

  // Page 3: You as a Parent This Week
  skillCelebrationTitle String?   // legacy — kept for backward compat
  scenarioCards         Json?     // legacy — kept for backward compat
  parentGrowthNarrative String?   // AI: identity-level celebration connecting skill to child impact
  growthMetrics         Json?     // JSON array: [{ icon, value, label }] — 2-3 data-driven micro-wins
  noraObservation       String?   // AI: 2 sentences about what changed in the parent's approach

  // Page 4: Weekly Moments Highlight
  // JSON array: [{ date, dayLabel, dateLabel, tag, sessionTitle, quote, celebration, audioUrl, startTime, endTime }]
  topMoments            Json?

  // Page 5: Child's Week — celebrate the child
  milestones            Json?     // legacy — kept for backward compat
  childSpotlight        String?   // AI: 2-3 sentence warm narrative about the child's week
  growthSnapshots       Json?     // JSON array: [{ category, icon, childQuote, meaning }] — evidence cards
  childProgressNote     String?   // AI: optional one-liner about progress since starting

  // Page 6: Next Week's Focus
  focusHeading          String?  // e.g. "Use narration during transitions"
  focusSubtext          String?  // e.g. "You don't need to be perfect — just consistent."
  whyExplanation        String?  // expandable "Why this matters" body text

  // Page 7: Quick Check-in (user responses)
  moodSelection         String?  // e.g. "Grounded", "Tired", "Stretched", "Hopeful"
  issueRatings          Json?    // { "Tantrums": "Better", "Hitting": "Same" }

  // Trend insights (enhances Page 2)
  depositsTrend          String?   // "up" | "down" | "stable"
  depositsChangePercent  Int?      // e.g. 40 means +40%
  trendMessage           String?   // AI: "Your praise increased 40% this week!"

  // Consistency tracking (enhances Page 2)
  sessionCount           Int       @default(0)
  uniqueDays             Int       @default(0)
  consistencyMessage     String?   // AI: "You showed up 4 out of 7 days!"

  // Growth insights
  strongestGrowthArea    String?   // "Praise", "Echo", "Narrate", etc.
  avgNoraScore           Int?      // 0-100 weekly average

  // Child response patterns (enhances Page 4/5)
  childResponseSummary   String?   // AI: synthesized child reaction patterns

  // Generation metadata
  generatedAt            DateTime?
  generationVersion      Int       @default(1)

  // Session IDs included in this report
  sessionIds            String[] @default([])

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  User  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  Child Child? @relation(fields: [childId], references: [id], onDelete: SetNull)

  @@unique([userId, weekStartDate])
  @@index([userId])
  @@index([userId, weekStartDate])
  @@index([weekStartDate, weekEndDate])
}
