generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model LearningProgress {
  id            String   @id
  userId        String   @unique
  currentDeck   Int      @default(1)
  unlockedDecks Int      @default(1)
  updatedAt     DateTime
  User          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Lesson {
  id                 String               @id
  phase              LessonPhase
  phaseNumber        Int
  dayNumber          Int
  title              String
  subtitle           String?
  shortDescription   String
  objectives         String[]
  estimatedMinutes   Int                  @default(2)
  isBooster          Boolean              @default(false)
  prerequisites      String[]
  teachesCategories  String[]
  dragonImageUrl     String?
  backgroundColor    String               @default("#E4E4FF")
  ellipse77Color     String               @default("#9BD4DF")
  ellipse78Color     String               @default("#A6E0CB")
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  LessonSegment      LessonSegment[]
  Quiz               Quiz?
  UserLessonProgress UserLessonProgress[]

  @@unique([phaseNumber, dayNumber])
  @@index([phaseNumber])
  @@index([phase, dayNumber])
}

model LessonSegment {
  id           String      @id
  lessonId     String
  order        Int
  sectionTitle String?
  contentType  ContentType
  bodyText     String
  imageUrl     String?
  iconType     String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime
  Lesson       Lesson      @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([lessonId, order])
  @@index([lessonId])
}

model ModuleHistory {
  id       String   @id
  userId   String
  category String
  level    Int
  viewedAt DateTime @default(now())
  User     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, category])
  @@index([userId])
  @@index([viewedAt])
}

model Phq2Survey {
  id          String   @id
  userId      String
  submittedAt DateTime @default(now())
  q1Interest  Int
  q2Depressed Int
  totalScore  Int
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([submittedAt])
  @@index([userId])
}

model Quiz {
  id            String         @id
  lessonId      String         @unique
  question      String
  correctAnswer String
  explanation   String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime
  Lesson        Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  QuizOption    QuizOption[]
  QuizResponse  QuizResponse[]

  @@index([lessonId])
}

model QuizOption {
  id          String @id
  quizId      String
  optionLabel String
  optionText  String
  order       Int
  Quiz        Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@unique([quizId, optionLabel])
  @@index([quizId])
}

model QuizResponse {
  id             String   @id
  userId         String
  quizId         String
  selectedAnswer String
  isCorrect      Boolean
  attemptNumber  Int      @default(1)
  respondedAt    DateTime @default(now())
  Quiz           Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  User           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([userId, quizId])
}

model RefreshToken {
  id        String   @id
  userId    String   @unique
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([tokenHash])
}

model PasswordResetToken {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model RiskAuditLog {
  id             String   @id
  userId         String
  sessionId      String?
  timestamp      DateTime @default(now())
  triggerSource  String
  riskLevel      String
  triggerExcerpt String?
  actionTaken    String
  User           User     @relation(fields: [userId], references: [id])

  @@index([riskLevel])
  @@index([timestamp])
  @@index([userId])
}

model Session {
  id                     String         @id
  userId                 String
  mode                   SessionMode
  storagePath            String
  durationSeconds        Int
  transcript             String
  aiFeedbackJSON         Json
  pcitCoding             Json
  tagCounts              Json
  masteryAchieved        Boolean        @default(false)
  riskScore              Int            @default(0)
  flaggedForReview       Boolean        @default(false)
  coachAlertSent         Boolean        @default(false)
  coachAlertSentAt       DateTime?
  createdAt              DateTime       @default(now())
  childMetrics           Json?
  competencyAnalysis     Json?
  overallScore           Int?
  elevenLabsJson         Json?
  roleIdentificationJson Json?
  transcriptionService   String?
  transcribedAt          DateTime?
  analysisStatus         AnalysisStatus @default(PENDING)
  analysisError          String?
  analysisFailedAt       DateTime?
  User                   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  Utterance              Utterance[]

  @@index([createdAt])
  @@index([flaggedForReview])
  @@index([mode])
  @@index([userId])
  @@index([analysisStatus])
}

model Utterance {
  id        String   @id @default(uuid())
  sessionId String
  speaker   String
  text      String
  startTime Float
  endTime   Float
  role      String?
  pcitTag   String?
  order     Int
  createdAt DateTime @default(now())
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, order])
  @@index([sessionId])
}

model SupportRequest {
  id            String               @id
  userId        String
  email         String
  description   String
  attachments   Json?
  status        SupportRequestStatus @default(OPEN)
  priority      SupportPriority      @default(MEDIUM)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime
  resolvedAt    DateTime?
  resolverNotes String?
  User          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([status])
  @@index([userId])
}

model ThirdPartyRequest {
  id          String   @id
  requestId   String   @unique
  userId      String
  provider    String
  requestType String
  dataHash    String?
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([expiresAt])
  @@index([requestId])
  @@index([userId])
}

model User {
  id                    String                 @id
  email                 String                 @unique
  passwordHash          String
  name                  String
  therapistId           String?
  childName             String
  createdAt             DateTime               @default(now())
  currentStreak         Int                    @default(0)
  lastSessionDate       DateTime?
  longestStreak         Int                    @default(0)
  childBirthYear        Int
  childConditions       String
  emailHash             String?                @unique
  childBirthday         DateTime?
  issue                 String?
  profileImageUrl       String?
  subscriptionEndDate   DateTime?
  subscriptionPlan      SubscriptionPlan       @default(TRIAL)
  subscriptionStartDate DateTime?
  subscriptionStatus    SubscriptionStatus     @default(ACTIVE)
  trialEndDate          DateTime?
  trialStartDate        DateTime?
  relationshipToChild   RelationshipToChild    @default(MOTHER)
  childGender           ChildGender?
  LearningProgress      LearningProgress?
  ModuleHistory         ModuleHistory[]
  PasswordResetToken    PasswordResetToken[]
  Phq2Survey            Phq2Survey[]
  QuizResponse          QuizResponse[]
  RiskAuditLog          RiskAuditLog[]
  Session               Session[]
  SupportRequest        SupportRequest[]
  ThirdPartyRequest     ThirdPartyRequest[]
  UserLessonProgress    UserLessonProgress[]
  WacbSurvey            WacbSurvey[]

  @@index([emailHash])
  @@index([therapistId])
}

model UserLessonProgress {
  id               String         @id
  userId           String
  lessonId         String
  status           ProgressStatus
  currentSegment   Int            @default(1)
  totalSegments    Int            @default(4)
  completedAt      DateTime?
  startedAt        DateTime       @default(now())
  lastViewedAt     DateTime       @default(now())
  timeSpentSeconds Int            @default(0)
  Lesson           Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  User             User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([lessonId])
  @@index([userId, status])
}

model WacbSurvey {
  id                   String   @id
  userId               String
  submittedAt          DateTime @default(now())
  parentingStressLevel Int
  q1Dawdle             Int
  q2MealBehavior       Int
  q3Disobey            Int
  q4Angry              Int
  q5Scream             Int
  q6Destroy            Int
  q7ProvokeFights      Int
  q8Interrupt          Int
  q9Attention          Int
  totalScore           Int
  User                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([submittedAt])
  @@index([userId])
}

enum ChildGender {
  BOY
  GIRL
  OTHER
}

enum ContentType {
  TEXT
  EXAMPLE
  TIP
  SCRIPT
  CALLOUT
}

enum LessonPhase {
  CONNECT
  DISCIPLINE
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  LOCKED
}

enum RelationshipToChild {
  MOTHER
  FATHER
  GUARDIAN
  OTHER
  GRANDMOTHER
  GRANDFATHER
}

enum SessionMode {
  CDI
  PDI
}

enum SubscriptionPlan {
  TRIAL
  PREMIUM
  FREE
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum SupportPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SupportRequestStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum AnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
