generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Keyword {
  id         String   @id
  term       String   @unique
  definition String
  createdAt  DateTime @default(now())
  updatedAt  DateTime

  @@index([term])
}

model LearningProgress {
  id            String   @id
  userId        String   @unique
  currentDeck   Int      @default(1)
  unlockedDecks Int      @default(1)
  updatedAt     DateTime
  User          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Lesson {
  id                 String               @id
  phase              LessonPhase
  phaseNumber        Int
  dayNumber          Int
  title              String
  subtitle           String?
  shortDescription   String
  objectives         String[]
  estimatedMinutes   Int                  @default(2)
  isBooster          Boolean              @default(false)
  prerequisites      String[]
  teachesCategories  String[]
  dragonImageUrl     String?
  backgroundColor    String               @default("#E4E4FF")
  ellipse77Color     String               @default("#9BD4DF")
  ellipse78Color     String               @default("#A6E0CB")
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  LessonSegment      LessonSegment[]
  Quiz               Quiz?
  UserLessonProgress UserLessonProgress[]

  @@unique([phaseNumber, dayNumber])
  @@index([phaseNumber])
  @@index([phase, dayNumber])
}

model LessonSegment {
  id                String              @id
  lessonId          String
  order             Int
  sectionTitle      String?
  contentType       ContentType
  bodyText          String
  imageUrl          String?
  iconType          String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  aiCheckMode       String?
  idealAnswer       String?
  Lesson            Lesson              @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  TextInputResponse TextInputResponse[]

  @@unique([lessonId, order])
  @@index([lessonId])
}

model ModuleHistory {
  id       String   @id
  userId   String
  category String
  level    Int
  viewedAt DateTime @default(now())
  User     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, category])
  @@index([userId])
  @@index([viewedAt])
}

model PasswordResetToken {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([token])
  @@index([userId])
}

model Phq2Survey {
  id          String   @id
  userId      String
  submittedAt DateTime @default(now())
  q1Interest  Int
  q2Depressed Int
  totalScore  Int
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([submittedAt])
  @@index([userId])
}

model Quiz {
  id            String         @id
  lessonId      String         @unique
  question      String
  correctAnswer String
  explanation   String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime
  Lesson        Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  QuizOption    QuizOption[]
  QuizResponse  QuizResponse[]

  @@index([lessonId])
}

model QuizOption {
  id          String @id
  quizId      String
  optionLabel String
  optionText  String
  order       Int
  Quiz        Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@unique([quizId, optionLabel])
  @@index([quizId])
}

model QuizResponse {
  id             String   @id
  userId         String
  quizId         String
  selectedAnswer String
  isCorrect      Boolean
  attemptNumber  Int      @default(1)
  respondedAt    DateTime @default(now())
  Quiz           Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  User           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([userId, quizId])
}

model RefreshToken {
  id        String   @id
  userId    String   @unique
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([tokenHash])
}

model RiskAuditLog {
  id             String   @id
  userId         String
  sessionId      String?
  timestamp      DateTime @default(now())
  triggerSource  String
  riskLevel      String
  triggerExcerpt String?
  actionTaken    String
  User           User     @relation(fields: [userId], references: [id])

  @@index([riskLevel])
  @@index([timestamp])
  @@index([userId])
}

model Session {
  id                     String         @id
  userId                 String
  mode                   SessionMode
  storagePath            String
  durationSeconds        Int
  transcript             String
  aiFeedbackJSON         Json
  pcitCoding             Json
  tagCounts              Json
  masteryAchieved        Boolean        @default(false)
  riskScore              Int            @default(0)
  flaggedForReview       Boolean        @default(false)
  coachAlertSent         Boolean        @default(false)
  coachAlertSentAt       DateTime?
  createdAt              DateTime       @default(now())
  childMetrics           Json?
  competencyAnalysis     Json?
  overallScore           Int?
  elevenLabsJson         Json?
  roleIdentificationJson Json?
  psychologistFeedback   Json?
  childPortfolioInsights Json?
  transcribedAt          DateTime?
  transcriptionService   String?
  analysisError          String?
  analysisFailedAt       DateTime?
  analysisStatus         AnalysisStatus @default(PENDING)
  lastRetriedAt          DateTime?
  permanentFailure       Boolean        @default(false)
  retryCount             Int            @default(0)
  User                   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  Utterance              Utterance[]

  @@index([analysisStatus])
  @@index([createdAt])
  @@index([flaggedForReview])
  @@index([mode])
  @@index([userId])
}

model SubscriptionEvent {
  id                String    @id
  userId            String
  revenueCatEventId String    @unique
  eventType         String
  productId         String
  expiresDate       DateTime?
  revenueCatData    Json
  createdAt         DateTime  @default(now())
  User              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([eventType])
  @@index([revenueCatEventId])
  @@index([userId])
}

model SupportRequest {
  id            String               @id
  userId        String
  email         String
  description   String
  attachments   Json?
  status        SupportRequestStatus @default(OPEN)
  priority      SupportPriority      @default(MEDIUM)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime
  resolvedAt    DateTime?
  resolverNotes String?
  User          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([status])
  @@index([userId])
}

model TextInputResponse {
  id            String        @id @default(uuid())
  userId        String
  segmentId     String
  userAnswer    String
  aiEvaluation  Json?
  isCorrect     Boolean       @default(false)
  score         Int?
  attemptNumber Int           @default(1)
  respondedAt   DateTime      @default(now())
  LessonSegment LessonSegment @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  User          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, segmentId])
}

model ThirdPartyRequest {
  id          String   @id
  requestId   String   @unique
  userId      String
  provider    String
  requestType String
  dataHash    String?
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([expiresAt])
  @@index([requestId])
  @@index([userId])
}

model User {
  id                    String               @id
  email                 String               @unique
  passwordHash          String
  name                  String
  therapistId           String?
  childName             String
  createdAt             DateTime             @default(now())
  currentStreak         Int                  @default(0)
  lastSessionDate       DateTime?
  longestStreak         Int                  @default(0)
  childBirthYear        Int
  childConditions       String
  emailHash             String?              @unique
  childBirthday         DateTime?
  issue                 String?
  profileImageUrl       String?
  subscriptionEndDate   DateTime?
  subscriptionPlan      SubscriptionPlan     @default(FREE)
  subscriptionStartDate DateTime?
  subscriptionStatus    SubscriptionStatus   @default(INACTIVE)
  trialEndDate          DateTime?
  trialStartDate        DateTime?
  relationshipToChild   RelationshipToChild  @default(MOTHER)
  childGender           ChildGender?
  pushToken             String?
  pushTokenUpdatedAt    DateTime?
  currentPhase          LessonPhase          @default(CONNECT)
  revenueCatCustomerId  String?              @unique
  LearningProgress      LearningProgress?
  ModuleHistory         ModuleHistory[]
  PasswordResetToken    PasswordResetToken[]
  Phq2Survey            Phq2Survey[]
  QuizResponse          QuizResponse[]
  RiskAuditLog          RiskAuditLog[]
  Session               Session[]
  SubscriptionEvent     SubscriptionEvent[]
  SupportRequest        SupportRequest[]
  TextInputResponse     TextInputResponse[]
  ThirdPartyRequest     ThirdPartyRequest[]
  UserLessonProgress    UserLessonProgress[]
  WacbSurvey            WacbSurvey[]

  @@index([emailHash])
  @@index([pushToken])
  @@index([therapistId])
}

model UserLessonProgress {
  id               String         @id
  userId           String
  lessonId         String
  status           ProgressStatus
  currentSegment   Int            @default(1)
  totalSegments    Int            @default(4)
  completedAt      DateTime?
  startedAt        DateTime       @default(now())
  lastViewedAt     DateTime       @default(now())
  timeSpentSeconds Int            @default(0)
  Lesson           Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  User             User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([lessonId])
  @@index([userId, status])
}

model Utterance {
  id              String   @id
  sessionId       String
  speaker         String
  text            String
  startTime       Float
  endTime         Float
  role            String?
  pcitTag         String?
  order           Int
  createdAt       DateTime @default(now())
  noraTag         String?
  feedback        String?
  additionalTip   String?
  revisedFeedback String?
  Session         Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([sessionId, order])
}

model WacbSurvey {
  id                   String   @id
  userId               String
  submittedAt          DateTime @default(now())
  parentingStressLevel Int
  q1Dawdle             Int
  q2MealBehavior       Int
  q3Disobey            Int
  q4Angry              Int
  q5Scream             Int
  q6Destroy            Int
  q7ProvokeFights      Int
  q8Interrupt          Int
  q9Attention          Int
  totalScore           Int
  User                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([submittedAt])
  @@index([userId])
}

enum AnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ChildGender {
  BOY
  GIRL
  OTHER
}

enum ContentType {
  TEXT
  EXAMPLE
  TIP
  SCRIPT
  CALLOUT
  TEXT_INPUT
}

enum LessonPhase {
  CONNECT
  DISCIPLINE
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  LOCKED
}

enum RelationshipToChild {
  MOTHER
  FATHER
  GUARDIAN
  OTHER
  GRANDMOTHER
  GRANDFATHER
}

enum SessionMode {
  CDI
  PDI
}

enum SubscriptionPlan {
  TRIAL
  PREMIUM
  FREE
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  NONE
  TRIAL
  INACTIVE
}

enum SupportPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SupportRequestStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}
